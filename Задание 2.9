#include <stdio.h>                          // Подключаем стандартную библиотеку ввода-вывода
#include <string.h>                         // Подключаем библиотеку для работы со строками
#include <stdlib.h>                         // Подключаем стандартную библиотеку (exit, malloc и др.)

#define MAX_LINE 256                    // Определяем максимальную длину строки
#define MAX_WORD 16                     // Максимальная длина одного слова (не используется)
#define MAX_FILENAME 256                // Максимальная длина имени файла

int main() {
    FILE *src, *dst;                        // Указатели на файлы: исходный и целевой
    char src_filename[MAX_FILENAME] = "source.txt";  // Имя исходного файла
    char dst_filename[MAX_FILENAME] = "filtered.txt"; // Имя результирующего файла
    char line[MAX_LINE];                    // Буфер для чтения строки
    char *word, *next_word;                 // Указатели для работы со словами
    int line_num = 1;                       // Счетчик номеров строк для вывода

    // Создаем исходный файл вручную с тестовыми данными
    src = fopen(src_filename, "w");         // Открываем файл для записи
    if (src == NULL) {                      // Проверяем успешность открытия
    	printf("Ошибка создания source.txt"); // Выводим сообщение об ошибке
        return 1;                           // Завершаем программу с ошибкой
    }

    // Записываем тестовые строки с длинными и короткими словами
    fprintf(src, "Programming in C language is fascinating.\n");
    fprintf(src, "Microcontroller development requires precision.\n");
    fprintf(src, "Supercalifragilisticexpialidocious is too long.\n");
    fprintf(src, "Embedded systems engineering is rewarding.\n");
    fprintf(src, "Antidisestablishmentarianism exceeds limit.\n");

    fclose(src);                            // Закрываем исходный файл
    printf("Исходный файл '%s' создан.\n", src_filename); // Сообщаем об успехе

    // Открываем файлы для копирования и фильтрации
    src = fopen(src_filename, "r");         // Открываем исходный файл для чтения
    if (src == NULL) {                      // Проверяем успешность открытия
    	printf("Ошибка открытия source.txt"); // Выводим сообщение об ошибке
        return 1;                           // Завершаем программу с ошибкой
    }

    dst = fopen(dst_filename, "w");         // Создаем/открываем целевой файл для записи
    if (dst == NULL) {                      // Проверяем успешность открытия
    	printf("Ошибка создания filtered.txt"); // Выводим сообщение об ошибке
        fclose(src);                        // Закрываем исходный файл
        return 1;                           // Завершаем программу с ошибкой
    }

    printf("\nОбработка файла построчно...\n\n"); // Заголовок для вывода процесса

    // Основной цикл обработки файла построчно
    while (fgets(line, sizeof(line), src)) { // Читаем строку из файла
        char temp_line[MAX_LINE * 2] = {0}; // Временный буфер для новой строки (удвоенный размер)
        char *pos = line;                   // Указатель на текущую позицию в строке

        printf("Строка %d: %s", line_num++, line); // Выводим номер и исходную строку

        // Разбиваем строку на слова с помощью strtok
        while ((word = strtok(pos, " \t\n\r")) != NULL) { // Извлекаем следующее слово. \t - табуляция, \n - новая строка, \r - курсор начала строки
            pos = NULL;                     // NULL для последующих вызовов strtok (продолжение строки)

            if (strlen(word) <= 15) {       // Проверяем длину слова
                // Слово подходит по длине - добавляем в результат
                strcat(temp_line, word);    // Копируем слово в результирующую строку
                strcat(temp_line, " ");     // Добавляем пробел после слова
                printf(" '%s' (%d символов)\n", word, strlen(word)); // Выводим статистику
            } else {
                // Слово слишком длинное - пропускаем
                printf(" '%s' (%d символов) - ПРОПУЩЕНО\n", word, strlen(word)); // Выводим статистику
            }
        }

        // Записываем обработанную строку в целевой файл
        if (strlen(temp_line) > 0) {        // Проверяем, есть ли содержимое
            temp_line[strlen(temp_line) - 1] = '\n'; // Заменяем последний пробел на перенос строки
            fputs(temp_line, dst);          // Записываем строку в файл
        }
    }

    fclose(src);                            // Закрываем исходный файл
    fclose(dst);                            // Закрываем целевой файл

    // Финальное сообщение об успешном завершении
    printf("\nФайл '%s' успешно создан!\n", dst_filename);
    printf("Все слова длиннее 15 символов удалены.\n");

    return 0;                               // Завершаем программу успешно
}
